<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arteon Ride – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="driver-wheel-icon.png" />

  <style>
    :root{
      --primary:#ff3600;
      --primary-dark:#d42d00;
      --bg:#0b1120;
      --card:#020617;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border: rgba(148, 163, 184, 0.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #020617 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:20px 10px 40px;
    }
    .page{width:100%; max-width:1000px;}
    .hero{
      position:relative;
      border-radius:32px;
      overflow:hidden;
      margin-bottom:18px;
      box-shadow:0 32px 80px rgba(15,23,42,.75);
      border:1px solid var(--border);
    }
    .hero img{
      width:100%;
      height:200px;
      object-fit:cover;
      display:block;
      opacity:.9;
    }
    .hero-title{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:clamp(28px,4vw,46px);
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#fff;
      text-shadow:0 10px 30px rgba(0,0,0,.85);
    }
    .layout{
      display:grid;
      grid-template-columns:0.45fr 0.55fr;
      gap:18px;
    }
    @media(max-width:900px){.layout{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(145deg,#020617,#020617f0);
      border-radius:24px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 20px 60px rgba(15,23,42,.8);
      padding:16px 16px 18px;
    }
    h2{
      font-size:16px;
      letter-spacing:.12em;
      text-transform:uppercase;
      margin-bottom:10px;
    }
    .muted{color:var(--muted); font-size:12px; line-height:1.4}
    .row{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    input, select{
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.65);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 16px;
      font-weight:700;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
      transition:.16s ease all;
      box-shadow:0 14px 36px rgba(248,113,113,.35);
      font-size:13px;
    }
    .btn:hover{background:var(--primary-dark); transform:translateY(-1px)}
    .btn.secondary{
      background:rgba(148,163,184,.18);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:none;
    }
    .btn.danger{
      background:rgba(244,63,94,.12);
      border:1px solid rgba(244,63,94,.35);
      box-shadow:none;
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .msg{margin-top:10px; font-size:12px; min-height:16px}
    .ok{color:#22c55e}
    .err{color:#fb7185}

    .login-wrap{max-width:520px; margin:0 auto}
    .list{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .item{
      border:1px solid rgba(148,163,184,.25);
      background:rgba(15,23,42,.45);
      border-radius:16px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .item strong{font-size:13px}
    .item small{font-size:11px; color:var(--muted)}
  </style>
</head>

<body>
<div class="page">
  <header class="hero">
    <img src="banner.jpg" alt="Arteon banner">
    <div class="hero-title">Admin Panel</div>
  </header>

  <!-- LOGIN -->
  <section class="login-wrap" id="loginWrap">
    <div class="card">
      <h2>Admin Login</h2>
      <div class="muted">Enter admin PIN (stored securely in DB)</div>

      <div class="row">
        <label>Admin PIN</label>
        <input type="password" id="pinInput" placeholder="••••">
      </div>

      <div class="actions">
        <button class="btn" id="loginBtn">Login</button>
        <a href="index.html" class="btn secondary" style="text-decoration:none">Back</a>
      </div>

      <div class="msg" id="loginMsg"></div>
    </div>
  </section>

  <!-- ADMIN UI -->
  <section id="adminUI" style="display:none">
    <main class="layout">
      <!-- CREATE TRIP -->
      <section class="card">
        <h2>Create Trip</h2>
        <div class="muted">
          Create <b>date + direction</b>.  
          Zurich→Ostrava = dropoff · Ostrava→Zurich = pickup
        </div>

        <div class="row">
          <label>Date</label>
          <input type="date" id="tripDate">
        </div>

        <div class="row">
          <label>Direction</label>
          <select id="tripDirection">
            <option value="ZO">Zurich → Ostrava</option>
            <option value="OZ">Ostrava → Zurich</option>
          </select>
        </div>

        <div class="actions">
          <button class="btn" id="addTripBtn">Add Trip</button>
        </div>

        <div class="msg" id="adminMsg"></div>

        <div style="margin-top:12px">
          <button class="btn secondary" id="logoutBtn">Logout</button>
        </div>
      </section>

      <!-- LIST TRIPS -->
      <section class="card">
        <h2>Trips</h2>
        <div class="muted">Stored locally for now (arteonTrips_v1)</div>
        <div class="list" id="tripList"></div>
      </section>
    </main>
  </section>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://rtqnbryjqiwnewmtdeqb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0cW5icnlqcWl3bmV3bXRkZXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MDE2NjgsImV4cCI6MjA4MTI3NzY2OH0.3HACsytbNMgBZ9wpspl7SI76OpAsoUMZGyK57mQhCro";
const SESSION_KEY = "arteon_admin_ok";
const TRIPS_KEY = "arteonTrips_v1";

/* ================= HELPERS ================= */
function loadTrips(){
  try{ return JSON.parse(localStorage.getItem(TRIPS_KEY)||"[]"); }
  catch{ return []; }
}
function saveTrips(t){ localStorage.setItem(TRIPS_KEY, JSON.stringify(t)); }
function uuid(){ return crypto.randomUUID(); }
function setMsg(id, txt, type=""){
  const el=document.getElementById(id);
  el.className="msg "+type;
  el.textContent=txt;
}

/* ================= AUTH ================= */
async function verifyPin(pin){
  const res = await fetch(`${SUPABASE_URL}/functions/v1/verify-admin-pin`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
    },
    body:JSON.stringify({ pin })
  });
  const data = await res.json();
  return !!data.ok;
}

function showLogin(){
  loginWrap.style.display="block";
  adminUI.style.display="none";
}
function showAdmin(){
  loginWrap.style.display="none";
  adminUI.style.display="block";
  renderTrips();
}

/* ================= TRIPS ================= */
function renderTrips(){
  const list=document.getElementById("tripList");
  const trips=loadTrips().sort((a,b)=>a.trip_date>b.trip_date?1:-1);
  list.innerHTML="";
  if(!trips.length){
    list.innerHTML='<div class="muted">No trips yet.</div>';
    return;
  }
  trips.forEach(t=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`
      <div>
        <strong>${t.trip_date} – ${t.from} → ${t.to}</strong>
        <small>stop_mode: ${t.stop_mode}</small>
      </div>
      <button class="btn danger">Delete</button>
    `;
    div.querySelector("button").onclick=()=>{
      saveTrips(trips.filter(x=>x.id!==t.id));
      renderTrips();
    };
    list.appendChild(div);
  });
}

/* ================= EVENTS ================= */
document.addEventListener("DOMContentLoaded",()=>{
  if(sessionStorage.getItem(SESSION_KEY)==="1") showAdmin();
  else showLogin();

  loginBtn.onclick=async()=>{
    const pin=pinInput.value.trim();
    if(!pin) return;
    const ok=await verifyPin(pin);
    if(ok){
      sessionStorage.setItem(SESSION_KEY,"1");
      showAdmin();
    } else setMsg("loginMsg","Wrong PIN","err");
  };

  logoutBtn.onclick=()=>{
    sessionStorage.removeItem(SESSION_KEY);
    showLogin();
  };

  addTripBtn.onclick=()=>{
    const d=tripDate.value;
    const dir=tripDirection.value;
    if(!d){ setMsg("adminMsg","Select date","err"); return; }
    const base = dir==="ZO"
      ? {from:"Zurich",to:"Ostrava",stop_mode:"dropoff"}
      : {from:"Ostrava",to:"Zurich",stop_mode:"pickup"};

    const trips=loadTrips();
    if(trips.some(t=>t.trip_date===d && t.from===base.from)){
      setMsg("adminMsg","Trip already exists","err"); return;
    }
    trips.push({ id:uuid(), trip_date:d, ...base });
    saveTrips(trips);
    setMsg("adminMsg","Trip added","ok");
    renderTrips();
  };
});
</script>
</body>
</html>
