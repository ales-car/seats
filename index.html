<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arteon Ride â€“ Seat Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" href="driver-wheel-icon.png" />

  <style>
    /* =========================================
       CSS (Dark Theme - Same as before)
       ========================================= */
    :root {
      --primary: #ff3600;
      --primary-dark: #d42d00;
      --bg: #0b1120;
      --card-bg: #020617;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;

      /* Seat colors */
      --seat-bg: rgba(15, 23, 42, 0.38);
      --seat-border: rgba(148, 163, 184, 0.7);
      --seat-selected-bg: rgba(248, 113, 113, 0.80);
      --seat-selected-border: rgba(254, 249, 195, 0.95);
      --seat-booked-bg: rgba(55, 65, 81, 0.85);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px 10px 40px;
    }

    .page { width: 100%; max-width: 1100px; }

    /* HERO BANNER */
    .hero {
      position: relative;
      border-radius: 32px;
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: 0 32px 80px rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .hero img {
      width: 100%;
      display: block;
      height: 230px;
      object-fit: cover;
      filter: saturate(1.1);
    }

    .hero-title {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(32px, 5vw, 52px);
      font-weight: 800;
      color: #fff;
      text-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    /* Layout */
    .layout {
      display: grid;
      grid-template-columns: 0.4fr 0.6fr;
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: linear-gradient(145deg, #020617, #020617f0);
      border-radius: 24px;
      padding: 18px 18px 20px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.8);
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      margin-bottom: 10px;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    /* DRIVER HEADER */
    .driver-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .driver-avatar {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(248, 250, 252, 0.9);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.8);
    }

    .driver-name { font-size: 17px; font-weight: 600; margin-bottom: 4px; }

    .driver-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .driver-meta span::before { content: "â€¢ "; color: var(--primary); }
    .driver-meta span:first-child::before { content: ""; }

    .driver-list {
      list-style: none;
      margin: 10px 0 12px;
      padding-left: 0;
      font-size: 13px;
      color: var(--text-main);
    }

    .driver-list li {
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .driver-list li::before {
      content: "â€¢";
      color: var(--primary);
      font-size: 16px;
    }

    .car-specs { margin-top: 8px; font-size: 12px; color: var(--text-muted); }
    .car-specs strong { color: #e5e7eb; }

    /* Trip + date + stop section */
    .trip-section {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
    }

    .trip-current { font-size: 12px; color: var(--text-muted); margin: 0 0 6px; }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .form-row label {
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
    }

    .form-row select,
    .form-row input[type="text"],
    .form-row input[type="tel"] {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
    }

    .form-row select:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Radio group */
    .radio-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .radio-item { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-main); }
    .radio-item input[type="radio"] { width: 14px; height: 14px; accent-color: var(--primary); cursor: pointer; }
    .radio-item span { cursor: pointer; }

    /* Right card: car + seats */
    .car-card-title {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .car-card-title h2 { margin-bottom: 0; }
    .car-card-title small { font-size: 11px; color: var(--text-muted); }

    .car-visual {
      position: relative;
      margin-top: 8px;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, #111827 0, #020617 45%);
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
    }

    .car-visual img { width: 100%; display: block; opacity: 0.92; }

    /* === SEAT GRID ==================== */
    .seat-grid {
      position: absolute;
      top: 43%;
      left: 30%;
      right: 35%;
      bottom: 25%;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 6px;
      pointer-events: none;
    }

    .seat {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--seat-bg);
      border-radius: 8px;
      border: 1px solid var(--seat-border);
      color: #fff;
      font-size: 13px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      pointer-events: auto;
      cursor: pointer;
      transition: 0.16s ease all;
      text-align: center;
      padding: 4px 2px;
    }

    .seat-label {
      font-weight: 600;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .seat-small {
      font-size: 10px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .seat-icon {
      width: 32px;
      height: auto;
      opacity: 0.75;
      margin-bottom: 2px;
    }

    .seat.driver-seat {
      cursor: default;
      pointer-events: none;
      background: rgba(0, 0, 0, 0.35);
    }

    .seat.selected {
      background: var(--seat-selected-bg);
      border-color: var(--seat-selected-border);
      box-shadow: 0 8px 24px rgba(255, 102, 0, 0.55);
      transform: translateY(-1px);
    }

    .seat.booked {
      background: var(--seat-booked-bg);
      border-color: rgba(0, 0, 0, 0.6);
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }

    .booked-tag {
      position: absolute;
      top: 3px;
      right: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.16s ease;
    }

    .seat.booked .booked-tag { opacity: 1; }

    .seat.disabled { cursor: not-allowed; opacity: 0.4; }

    /* Legend & status */
    .status-row {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
    }

    .status-row strong { color: #fbbf24; }

    .legend {
      display: flex;
      gap: 12px;
      font-size: 11px;
      margin-top: 10px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .legend-item { display: flex; align-items: center; gap: 6px; }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.7);
    }

    .legend-dot.selected { background: var(--seat-selected-bg); border-color: var(--seat-selected-border); }
    .legend-dot.booked { background: var(--seat-booked-bg); border-color: rgba(0, 0, 0, 0.8); }
    .legend-dot.driver { background: rgba(0, 0, 0, 0.9); border-color: #000; }

    .btn-row {
      margin-top: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-primary {
      padding: 9px 22px;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 14px 36px rgba(248, 113, 113, 0.55);
      transition: 0.16s ease all;
    }

    .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-primary:disabled { background: #4b5563; box-shadow: none; cursor: not-allowed; }

    .price-chip {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.85);
    }

    .message { margin-top: 10px; font-size: 12px; min-height: 16px; }
    .message.ok { color: #22c55e; }
    .message.error { color: #f97373; }

    .contact-actions {
      margin-top: 10px;
      display: none;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-ghost {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.55);
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-ghost:hover { border-color: rgba(255,255,255,0.6); }

    footer {
      margin-top: 18px;
      text-align: center;
      color: #9ca3af;
      font-size: 12px;
    }
    footer a { color: #9ca3af; text-decoration: underline; margin: 0 10px; }
  </style>
</head>

<body>
  <div class="page">
    <header class="hero">
      <img src="banner.jpg" alt="Arteon banner" />
      <div class="hero-title">Select Your Car Seat</div>
    </header>

    <main class="layout">
      <section class="card">
        <div class="pill">
          <span class="pill-dot"></span>
          Verified ride Â· Real driver Â· 3 passenger seats only
        </div>

        <div class="driver-header">
          <img src="driver-photo.jpg" alt="Your driver" class="driver-avatar" />
          <div>
            <div class="driver-name">AleÅ¡ Krajina</div>
            <div class="driver-meta">
              <span>Non-smoker</span>
              <span>Safe ride</span>
              <span>Comfort first</span>
            </div>
          </div>
        </div>

        <ul class="driver-list">
          <li>Czech guy in Switzerland â€“ long-distance rides ZÃ¼rich â†” Czechia.</li>
          <li>Calm driving, good music, clean car.</li>
          <li>You can book 1â€“3 seats (VIP / Mood Bringer / Chief DJ).</li>
        </ul>

        <div class="car-specs">
          <strong>About the car:</strong><br />
          VW Arteon 2.0 TDI Shooting Brake <strong>R-Line</strong> (147 kW) â€“ premium long-distance cruiser,
          big luggage area and comfy rear seats.
        </div>

        <div class="trip-section">
          <div class="section-title">Trip & Date</div>
          <p id="tripCurrent" class="trip-current">
            No trip selected yet â€“ choose one below.
          </p>

          <div class="form-row">
            <label for="tripSelect">Available trips</label>
            <select id="tripSelect">
              <option value="">â€“ Loading tripsâ€¦ â€“</option>
            </select>
          </div>

          <div class="form-row">
            <label id="stopLabel">Stop</label>
            <div class="radio-group" id="stopRadios">
              <label class="radio-item">
                <input type="radio" name="stop" value="praha" data-price="50" disabled />
                <span>Praha (50 CHF)</span>
              </label>
              <label class="radio-item">
                <input type="radio" name="stop" value="brno" data-price="70" disabled />
                <span>Brno (70 CHF)</span>
              </label>
              <label class="radio-item">
                <input type="radio" name="stop" value="ostrava" data-price="80" disabled />
                <span>Ostrava (80 CHF)</span>
              </label>
            </div>
          </div>

          <div class="form-row">
            <label for="custName">Your name (optional)</label>
            <input id="custName" type="text" placeholder="e.g. Jakub" />
          </div>

          <div class="form-row">
            <label for="custPhone">Phone (optional)</label>
            <input id="custPhone" type="tel" placeholder="+420..." />
          </div>
          <p style="margin-top:10px;font-size:12px;color:#9ca3af;">
            Driver only: <a href="admin.html" style="color:#ff3600;">open admin</a>
          </p>
        </div>
      </section>

      <section class="card">
        <div class="car-card-title">
          <h2>Choose your place in the Arteon</h2>
          <small>VIP + Mood Bringer + Chief DJ</small>
        </div>

        <div class="car-visual">
          <img src="car-top-vertical.jpg" alt="Top-down view of VW Arteon" />

          <div class="seat-grid">
            <div class="seat driver-seat" data-seat-id="DRV">
              <img src="driver-wheel-icon.png" alt="Driver" class="seat-icon" />
              <div class="seat-label">DRIVER</div>
              <div class="seat-small">Not bookable</div>
            </div>

            <div class="seat" data-seat-id="VIP">
              <img src="vip-icon.png" alt="VIP" class="seat-icon" />
              <div class="seat-label">CO-PILOT</div>
              <div class="seat-small">Front passenger</div>
              <div class="booked-tag">BOOKED</div>
            </div>

            <div class="seat" data-seat-id="MB">
              <div class="seat-label">MOOD BRINGER</div>
              <div class="seat-small">Rear left</div>
              <div class="booked-tag">BOOKED</div>
            </div>

            <div class="seat" data-seat-id="DJ">
              <div class="seat-label">CHIEF DJ</div>
              <div class="seat-small">Rear right</div>
              <div class="booked-tag">BOOKED</div>
            </div>
          </div>
        </div>

        <div class="status-row" id="seatStatus">
          Select a trip and stop to see seat availability.
        </div>

        <div class="legend">
          <div class="legend-item"><span class="legend-dot driver"></span> Driver</div>
          <div class="legend-item"><span class="legend-dot"></span> Free</div>
          <div class="legend-item"><span class="legend-dot selected"></span> Selected</div>
          <div class="legend-item"><span class="legend-dot booked"></span> Booked</div>
        </div>

        <div class="btn-row">
          <div class="price-chip" id="priceDisplay">Choose stop & seat(s) to see price</div>
          <button type="button" class="btn-primary" id="confirmBtn" disabled>
            Confirm Booking
          </button>
        </div>

        <div id="message" class="message"></div>

        <div class="contact-actions" id="contactActions">
          <a class="btn-ghost" id="waBtn" href="#" target="_blank" rel="noopener">WhatsApp</a>
          <a class="btn-ghost" id="msBtn" href="#" target="_blank" rel="noopener">Messenger</a>
          <a class="btn-ghost" id="emBtn" href="#" target="_blank" rel="noopener">Email</a>
        </div>
      </section>
    </main>

    <footer>
      <a href="./privacy-policy.html">ZÃ¡sady ochrany soukromÃ­</a>
      <a href="./terms.html">PodmÃ­nky pouÅ¾itÃ­</a>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1) FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAi6MYAsAnqJg_5XwQC7b6TAI1ywrrADsM",
      authDomain: "car-seats-booking.firebaseapp.com",
      projectId: "car-seats-booking",
      storageBucket: "car-seats-booking.firebasestorage.app",
      messagingSenderId: "193508754028",
      appId: "1:193508754028:web:f7bc0b8cbdee9ef355ce49",
      measurementId: "G-QGXXTCG7XG"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 2) APP CONFIG
    const OWNER_WHATSAPP = "+41767775898";
    const OWNER_FB_PROFILE = "https://www.facebook.com/ales.krajina/";
    const OWNER_EMAIL = "ales.krajina@yourmail.com"; 

    const SEAT_IDS = ["VIP", "MB", "DJ"]; // DRV not bookable

    const STOP_PRICES = {
      praha: 50,
      brno: 70,
      ostrava: 80
    };

    let trips = [];
    let currentTripId = "";
    let currentTripObj = null;
    let currentStop = "";
    let selectedSeats = new Set();
    let bookedSeats = new Set(); 

    // 3) UI HELPERS
    function setMessage(text, type = "") {
      const msgEl = document.getElementById("message");
      msgEl.className = "message " + (type || "");
      msgEl.textContent = text;
    }

    function setStopRadiosEnabled(enabled) {
      document.querySelectorAll('input[name="stop"]').forEach(r => {
        r.disabled = !enabled;
        if (!enabled) r.checked = false;
      });
    }

    function clearStopSelection() {
      document.querySelectorAll('input[name="stop"]').forEach(r => r.checked = false);
    }

    function formatTripLabel(t) {
      return `${t.date} â€“ ${t.from} â†’ ${t.to}`;
    }

    function updateStopLabel() {
      const stopLabel = document.getElementById("stopLabel");
      if (!currentTripObj) {
        stopLabel.textContent = "Stop";
        return;
      }
      if (currentTripObj.from === "Zurich" && currentTripObj.to === "Ostrava") {
        stopLabel.textContent = "I get off in:";
      } else if (currentTripObj.from === "Ostrava" && currentTripObj.to === "Zurich") {
        stopLabel.textContent = "I start from:";
      } else {
        stopLabel.textContent = "Stop:";
      }
    }

    function updateSeatVisuals() {
      const seats = document.querySelectorAll(".seat");
      seats.forEach(seat => {
        const id = seat.dataset.seatId;
        seat.classList.remove("selected", "booked", "disabled", "driver-seat");

        if (id === "DRV") {
          seat.classList.add("driver-seat");
          return;
        }

        if (!currentTripId || !currentStop) {
          seat.classList.add("disabled");
          return;
        }

        if (bookedSeats.has(id)) {
          seat.classList.add("booked");
          return;
        }

        if (selectedSeats.has(id)) {
          seat.classList.add("selected");
        }
      });
    }

    function updateStatusAndPrice() {
      const statusEl = document.getElementById("seatStatus");
      const priceEl = document.getElementById("priceDisplay");
      const confirmBtn = document.getElementById("confirmBtn");
      const contactActions = document.getElementById("contactActions");

      contactActions.style.display = "none";

      if (!currentTripId) {
        statusEl.textContent = "Select a trip to see seat availability.";
        priceEl.textContent = "Choose stop & seat(s) to see price";
        confirmBtn.disabled = true;
        return;
      }

      if (!currentStop) {
        statusEl.textContent = "Trip selected. Now choose your stop (Praha / Brno / Ostrava).";
        priceEl.textContent = "Select stop & seat(s) to see total price";
        confirmBtn.disabled = true;
        return;
      }

      const bookedCount = [...bookedSeats].filter(s => SEAT_IDS.includes(s)).length;
      const freeCount = SEAT_IDS.length - bookedCount;

      const basePrice = STOP_PRICES[currentStop] || 0;
      const seatCount = selectedSeats.size;

      statusEl.innerHTML = `For this trip: <strong>${bookedCount}</strong> booked, <strong>${freeCount}</strong> free.`;

      if (seatCount > 0 && basePrice > 0) {
        const total = seatCount * basePrice;
        priceEl.textContent = `${seatCount} seat(s) Ã— ${basePrice} CHF = ${total} CHF`;
        confirmBtn.disabled = false;
      } else {
        priceEl.textContent = "Select at least one seat to see total price.";
        confirmBtn.disabled = true;
      }
    }

    // 4) FIREBASE DATA OPERATIONS
    async function fetchTrips() {
      const querySnapshot = await getDocs(collection(db, "trips"));
      const list = [];
      
      querySnapshot.forEach((doc) => {
        const t = doc.data();
        list.push({
          id: doc.id,
          date: t.trip_date,
          // Since we stored fields directly in Firestore, we access them directly
          from: t.from_city || "?",
          to: t.to_city || "?"
        });
      });

      // Sort trips by date locally
      list.sort((a, b) => new Date(a.date) - new Date(b.date));
      return list;
    }

    async function fetchBookedSeats(tripId) {
      const q = query(collection(db, "bookings"), where("trip_id", "==", tripId));
      const querySnapshot = await getDocs(q);
      
      const seats = new Set();
      querySnapshot.forEach((doc) => {
        seats.add(doc.data().seat_code);
      });
      return seats;
    }

    async function createBookings({ tripId, stopCity, price, seats, name, phone, channel }) {
      // Create a promise for each seat booking
      const promises = seats.map(seat => {
        return addDoc(collection(db, "bookings"), {
          trip_id: tripId,
          seat_code: seat,
          stop_city: stopCity,
          price_chf: price,
          customer_name: name || null,
          customer_phone: phone || null,
          contact_channel: channel,
          created_at: new Date().toISOString()
        });
      });

      await Promise.all(promises);
    }

    // 5) UI EVENT HANDLERS
    async function refreshTripSelect() {
      const sel = document.getElementById("tripSelect");
      sel.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "â€“ Select a trip â€“";
      sel.appendChild(opt0);

      if (!trips.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.disabled = true;
        opt.textContent = "No trips available (admin needs to add them)";
        sel.appendChild(opt);
        return;
      }

      trips.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = formatTripLabel(t);
        sel.appendChild(opt);
      });
    }

    async function handleTripChange() {
      const sel = document.getElementById("tripSelect");
      const tripCurrent = document.getElementById("tripCurrent");

      currentTripId = sel.value || "";
      currentTripObj = trips.find(t => t.id === currentTripId) || null;

      selectedSeats.clear();
      bookedSeats = new Set();
      currentStop = "";
      clearStopSelection();
      setStopRadiosEnabled(!!currentTripId);
      updateStopLabel();

      if (!currentTripId) {
        tripCurrent.textContent = "No trip selected yet â€“ choose one below.";
        updateSeatVisuals();
        updateStatusAndPrice();
        setMessage("");
        return;
      }

      tripCurrent.textContent = `Selected trip: ${formatTripLabel(currentTripObj)}`;

      try {
        setMessage("Loading seat availabilityâ€¦");
        bookedSeats = await fetchBookedSeats(currentTripId);
        setMessage("");
      } catch (e) {
        console.error(e);
        setMessage("Failed to load bookings. Check internet connection.", "error");
      }

      updateSeatVisuals();
      updateStatusAndPrice();
    }

    function handleStopChange(e) {
      const radio = e.target;
      if (!radio.checked) return;

      currentStop = radio.value || "";
      selectedSeats.clear();

      updateSeatVisuals();
      updateStatusAndPrice();
      setMessage("");
    }

    function handleSeatClick(e) {
      const seatElem = e.currentTarget;
      const seatId = seatElem.dataset.seatId;

      if (seatId === "DRV") return;
      if (!currentTripId || !currentStop) return;
      if (bookedSeats.has(seatId)) return;

      if (selectedSeats.has(seatId)) selectedSeats.delete(seatId);
      else selectedSeats.add(seatId);

      updateSeatVisuals();
      updateStatusAndPrice();
      setMessage("");
    }

    function buildSummaryText({ trip, stop, seats, basePrice }) {
      const seatsArr = [...seats];
      const total = seatsArr.length * basePrice;

      return [
        "ðŸš— Arteon Ride booking",
        `Trip: ${trip.date} â€“ ${trip.from} â†’ ${trip.to}`,
        (trip.from === "Zurich" && trip.to === "Ostrava") ? `Drop-off: ${stop}` :
        (trip.from === "Ostrava" && trip.to === "Zurich") ? `Pickup: ${stop}` :
        `Stop: ${stop}`,
        `Seats: ${seatsArr.join(", ")}`,
        `Price: ${seatsArr.length} Ã— ${basePrice} CHF = ${total} CHF`
      ].join("\n");
    }

    function showContactButtons(summaryText) {
      const contactActions = document.getElementById("contactActions");
      const waBtn = document.getElementById("waBtn");
      const msBtn = document.getElementById("msBtn");
      const emBtn = document.getElementById("emBtn");

      const waText = encodeURIComponent(summaryText);
      const waPhone = OWNER_WHATSAPP.replace(/\D/g, ""); // digits only
      waBtn.href = `https://wa.me/${waPhone}?text=${waText}`;

      msBtn.href = "https://www.messenger.com/t/" + encodeURIComponent(OWNER_FB_PROFILE);

      const mailSubj = encodeURIComponent("Arteon Ride booking");
      const mailBody = encodeURIComponent(summaryText);
      emBtn.href = `mailto:${encodeURIComponent(OWNER_EMAIL)}?subject=${mailSubj}&body=${mailBody}`;

      contactActions.style.display = "flex";
    }

    async function handleConfirmBooking() {
      if (!currentTripId || !currentTripObj) {
        setMessage("Please select a trip first.", "error");
        return;
      }
      if (!currentStop) {
        setMessage("Please select a stop (Praha/Brno/Ostrava).", "error");
        return;
      }
      if (!selectedSeats.size) {
        setMessage("Select at least one seat.", "error");
        return;
      }

      const basePrice = STOP_PRICES[currentStop] || 0;
      const seatsToBook = [...selectedSeats];

      const name = document.getElementById("custName").value.trim();
      const phone = document.getElementById("custPhone").value.trim();

      try {
        setMessage("Saving bookingâ€¦");

        await createBookings({
          tripId: currentTripId,
          stopCity: currentStop,
          price: basePrice,
          seats: seatsToBook,
          name,
          phone,
          channel: "web"
        });

        // refresh booked seats from DB (source of truth)
        bookedSeats = await fetchBookedSeats(currentTripId);

        const summary = buildSummaryText({
          trip: currentTripObj,
          stop: currentStop,
          seats: new Set(seatsToBook),
          basePrice
        });

        selectedSeats.clear();
        updateSeatVisuals();
        updateStatusAndPrice();

        setMessage("âœ… Booking stored! Send me the message to confirm.", "ok");
        showContactButtons(summary);

      } catch (e) {
        console.error(e);
        setMessage("âš ï¸ Booking failed (Seat might be taken).", "error");
        
        // Refresh to check if someone else took it
        try {
          bookedSeats = await fetchBookedSeats(currentTripId);
          selectedSeats.clear();
          updateSeatVisuals();
          updateStatusAndPrice();
        } catch {}
      }
    }

    // 6) INIT
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        setMessage("Loading tripsâ€¦");
        trips = await fetchTrips();
        await refreshTripSelect();
        setMessage("");

      } catch (e) {
        console.error(e);
        const sel = document.getElementById("tripSelect");
        sel.innerHTML = `<option value="">DB error</option>`;
        setMessage("DB error â€“ check console.", "error");
      }

      document.querySelectorAll(".seat").forEach(seat => {
        seat.addEventListener("click", handleSeatClick);
      });

      document.getElementById("tripSelect").addEventListener("change", handleTripChange);

      document.querySelectorAll('input[name="stop"]').forEach(radio => {
        radio.addEventListener("change", handleStopChange);
      });

      document.getElementById("confirmBtn").addEventListener("click", handleConfirmBooking);

      setStopRadiosEnabled(false);
      updateSeatVisuals();
      updateStatusAndPrice();
    });
  </script>
</body>
</html>
