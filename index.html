<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Arteon Ride ‚Äì Rezervace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="driver-wheel-icon.png" />

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script type="text/javascript">
     // V√Å≈† PUBLIC KEY
     (function(){
        emailjs.init("su3dGUSnWheulaTcr"); 
     })();
  </script>

  <style>
    /* =========================================
       CSS (Dark Theme)
       ========================================= */
    :root {
      --primary: #be123c; 
      --primary-hover: #9f1239; 
      --bg: #0b1120;
      --text-main: #e2e8f0;
      --text-muted: #94a3b8;
      
      --seat-bg: rgba(30, 41, 59, 0.5);
      --seat-border: rgba(51, 65, 85, 0.5);
      --free-bg: rgba(16, 185, 129, 0.2); 
      --free-border: rgba(16, 185, 129, 0.4);
      --booked-bg: rgba(30, 58, 138, 0.3); 
      --booked-border: rgba(30, 58, 138, 0.5);
      --selected-bg: rgba(190, 18, 60, 0.8); 
      --selected-border: rgba(253, 164, 175, 0.8);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 60%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex; justify-content: center; padding: 20px 10px 60px;
    }

    .page { width: 100%; max-width: 1100px; }

    /* HERO */
    .hero {
      position: relative; border-radius: 24px; overflow: hidden; margin-bottom: 25px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .hero img { width: 100%; display: block; height: 200px; object-fit: cover; filter: brightness(0.8); }
    .hero-title {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
      font-size: clamp(28px, 4vw, 42px); font-weight: 800; color: #fff;
      text-transform: uppercase; letter-spacing: 0.05em; text-shadow: 0 4px 20px rgba(0,0,0,0.8);
    }

    /* LAYOUT */
    .layout { display: grid; grid-template-columns: 0.45fr 0.55fr; gap: 25px; align-items: flex-start; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(160deg, #0f172a, #020617);
      border-radius: 20px; padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    }

    /* === NOV√â STYLY PRO BIO A AUTO === */
    .info-box { margin-bottom: 25px; font-size: 13px; color: var(--text-muted); line-height: 1.6; }
    
    .driver-mini { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; position: relative; }
    .driver-mini img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); }
    .driver-text { display: flex; flex-direction: column; }
    .driver-name { font-size: 16px; font-weight: 700; color: #fff; }
    .driver-tag { font-size: 12px; color: var(--primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Social Icons */
    .driver-socials { margin-left: auto; display: flex; gap: 8px; }
    .social-mini-link {
        color: var(--text-muted); transition: 0.2s; display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.05); width: 34px; height: 34px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
    }
    .social-mini-link:hover { color: #fff; background: var(--primary); border-color: var(--primary); transform: translateY(-2px); }
    .social-mini-icon { width: 18px; height: 18px; fill: currentColor; }

    /* Bio Typography */
    .bio-highlight { display: block; color: #fff; font-weight: 600; font-size: 14px; margin-bottom: 6px; }
    .bio-text p { margin-bottom: 12px; font-size: 13px; opacity: 0.9; }
    .bio-text p:last-child { margin-bottom: 0; }

    /* Fun Fact Pill */
    .fun-fact-box {
        margin-top: 15px; padding: 12px 16px; border-radius: 12px;
        background: rgba(190, 18, 60, 0.1); border: 1px solid rgba(190, 18, 60, 0.25);
        color: #fecdd3; font-size: 12px; display: flex; gap: 10px; align-items: flex-start;
    }
    .fun-fact-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

    /* CAR CARD - SAMOSTATN√Å KARTA */
    .car-card {
        margin-top: 30px;
        background: rgba(30, 41, 59, 0.35); /* Tmav≈°√≠ podklad */
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 18px;
    }
    .car-header {
        display: flex; align-items: center; gap: 8px;
        font-size: 15px; font-weight: 700; color: #fff;
        text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;
    }
    .car-model { font-size: 13px; color: var(--primary); font-weight: 600; margin-bottom: 12px; display: block; }
    
    .car-specs-list { list-style: none; padding: 0; margin: 0 0 15px 0; }
    .car-specs-list li { margin-bottom: 6px; font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
    .check-icon { color: var(--primary); font-weight: bold; font-size: 14px; }

    .car-features-mini { display: flex; gap: 15px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 12px; }
    .feature-item { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); flex: 1; }
    .feature-icon { width: 20px; height: 20px; fill: #e2e8f0; opacity: 0.8; }

    /* GALERIE */
    .car-gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 30px; margin-top: 10px; }
    .gallery-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; cursor: pointer; transition: transform 0.2s, filter 0.2s; border: 2px solid #ffffff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .gallery-thumb:hover { transform: scale(1.05); filter: brightness(1.2); z-index: 1; border-color: var(--primary); }

    /* WIZARD & REST */
    .step-container { margin-bottom: 25px; animation: fadeIn 0.4s ease; }
    .step-container.hidden { display: none; }
    .step-header { font-size: 14px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .step-num { background: rgba(255,255,255,0.9); color: #0f172a; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; }

    select, input { width: 100%; border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.2); padding: 12px; background: rgba(15, 23, 42, 0.6); color: #fff; font-size: 14px; outline: none; transition: border-color 0.2s; }
    select:focus, input:focus { border-color: var(--primary); }
    option:disabled { color: #9ca3af; background-color: #1e293b; }
    
    .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
    .radio-item, .addon-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,0.03); border-radius: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    .radio-item:hover, .addon-item:hover { background: rgba(255,255,255,0.06); }
    .radio-item.active, .addon-item.active { border-color: var(--primary); background: rgba(190, 18, 60, 0.1); }
    .radio-item input, .addon-item input { width: auto; margin: 0; accent-color: var(--primary); }
    .addon-label { flex: 1; font-size: 13px; color: #e2e8f0; }
    .addon-price { font-size: 12px; font-weight: 700; color: #fbbf24; }
    .addon-category { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin: 10px 0 4px 0; letter-spacing: 0.05em; font-weight: 700; }

    /* LIGHTBOX */
    .lightbox { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
    .lightbox-content-wrapper { position: relative; width: 70%; max-width: 1000px; display: flex; justify-content: center; align-items: center; }
    .lightbox img { width: 100%; height: auto; max-height: 85vh; object-fit: contain; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.1); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; z-index: 10001; }
    .nav-btn:hover { background: var(--primary); }
    .nav-prev { left: -80px; } .nav-next { right: -80px; } 
    .lightbox-close-hint { position: absolute; top: 20px; right: 20px; color: rgba(255,255,255,0.7); font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; }
    .lightbox-close-hint:hover { color: #fff; background: var(--primary); }

    /* RIGHT COLUMN */
    .car-visual { position: relative; margin: 10px auto; border-radius: 24px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); background: radial-gradient(circle, #1e293b 0%, #020617 60%); max-width: 340px; }
    .car-visual img { width: 100%; display: block; opacity: 0.9; }
    .stats-float { position: absolute; top: 15px; left: 15px; background: rgba(2, 6, 23, 0.8); backdrop-filter: blur(8px); padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
    .stat-row { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 2px; }
    .stat-num { font-size: 16px; font-weight: 700; color: #fff; }
    .stat-num.free { color: #34d399; } 

    .seat-grid { position: absolute; top: 43%; left: 30%; right: 35%; bottom: 25%; display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
    .seat { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--seat-bg); border-radius: 8px; border: 1px solid var(--seat-border); color: rgba(255,255,255,0.8); cursor: pointer; transition: 0.2s all; padding: 4px; }
    .seat.disabled { opacity: 0.3; cursor: not-allowed; }
    .seat:not(.booked):not(.selected):not(.disabled):not(.driver-seat) { background: var(--free-bg); border-color: var(--free-border); }
    .seat:not(.booked):not(.selected):not(.disabled):not(.driver-seat):hover { background: rgba(16, 185, 129, 0.4); }
    .seat.selected { background: var(--selected-bg); border-color: var(--selected-border); transform: scale(1.05); z-index: 2; box-shadow: 0 0 15px rgba(190, 18, 60, 0.5); color: #fff; }
    .seat.booked { background: var(--booked-bg); border-color: var(--booked-border); cursor: not-allowed; opacity: 0.8; }
    .seat.driver-seat { cursor: default; pointer-events: none; background: rgba(0,0,0,0.4); border-color: transparent; }
    .seat-label { font-size: 10px; font-weight: 700; margin-top: 2px; }
    .seat-icon { width: 24px; opacity: 0.8; }

    .legend { display: flex; gap: 15px; justify-content: center; margin-top: 15px; font-size: 12px; color: var(--text-muted); }
    .dot { width: 10px; height: 10px; border-radius: 2px; margin-right: 6px; display: inline-block; }
    .dot.free { background: var(--free-bg); border: 1px solid var(--free-border); }
    .dot.booked { background: var(--booked-bg); border: 1px solid var(--booked-border); }
    .dot.selected { background: var(--selected-bg); border: 1px solid var(--selected-border); }

    .btn-block { margin-top: 20px; }
    .btn-main { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(190, 18, 60, 0.3); }
    .btn-main:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); }
    .btn-main:disabled { background: #334155; color: #64748b; cursor: not-allowed; box-shadow: none; }
    .price-display { text-align: center; font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 10px; min-height: 24px; }

    .success-box { margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: none; animation: fadeIn 0.5s; }
    .success-title { text-align: center; color: #fff; font-weight: 600; margin-bottom: 15px; }
    .social-btns { display: flex; flex-direction: column; gap: 10px; }
    .social-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 10px; text-decoration: none; color: #fff; font-weight: 600; font-size: 14px; transition: 0.2s; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
    .social-btn:hover { filter: brightness(1.1); }
    .social-btn.wa { background: #15803d; border-color: #166534; }
    .social-btn.ms { background: #0369a1; border-color: #075985; }
    .social-btn.em { background: #334155; border-color: #1e293b; }
    .social-icon { width: 20px; height: 20px; fill: currentColor; }
    .copy-hint { font-size: 11px; font-weight: normal; opacity: 0.8; margin-left: 5px; }

    .message { text-align: center; margin-top: 10px; font-size: 13px; min-height: 20px; }
    .message.error { color: #f87171; }
    .legal-links { margin-top: 20px; text-align: center; font-size: 11px; color: #64748b; }
    .legal-links a { color: #64748b; text-decoration: underline; margin: 0 8px; }
    .footer-disclaimer { margin-top: 15px; text-align: center; font-size: 10px; color: #475569; max-width: 80%; margin-left: auto; margin-right: auto; line-height: 1.4; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 600px) { .nav-btn { display: none; } .lightbox-content-wrapper { width: 95%; } }
  </style>
</head>

<body>
  <div class="page">
    <header class="hero">
      <img src="banner.jpg" alt="Banner" />
      <div class="hero-title">Spoluj√≠zda s Ale≈°em</div>
    </header>

    <main class="layout">
      <section class="card">
        
        <div class="info-box">
          <div class="driver-mini">
            <img src="driver-photo.jpg" alt="Ale≈°">
            <div class="driver-text">
              <span class="driver-name">Ale≈° Krajina</span>
              <span class="driver-tag">POHODOV√Å J√çZDA</span>
            </div>
            
            <div class="driver-socials">
                <a id="lnkInsta" href="#" target="_blank" class="social-mini-link" style="display:none" title="Instagram">
                    <svg class="social-mini-icon" viewBox="0 0 24 24"><path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/></svg>
                </a>
                <a id="lnkFb" href="#" target="_blank" class="social-mini-link" style="display:none" title="Facebook">
                    <svg class="social-mini-icon" viewBox="0 0 24 24"><path d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5 3.66 9.15 8.44 9.9v-7H7.9v-2.9h2.54V9.85c0-2.51 1.49-3.89 3.78-3.89 1.09 0 2.23.19 2.23.19v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.45 2.9h-2.33v7a10 10 0 0 0 8.44-9.9c0-5.53-4.5-10.02-10-10.02z"/></svg>
                </a>
            </div>
          </div>
          
          <div class="bio-text">
              <span class="bio-highlight">Nejde o taxislu≈æbu, ale o klidn√© sd√≠len√≠ cesty na domluvƒõ.</span>
              <p>Pohodov√° spoluj√≠zda mezi ≈†v√Ωcarskem a ƒåeskem. Jezd√≠m plynule a bezpeƒçnƒõ. Auto je ƒçist√©, tich√© a dob≈ôe vybaven√©. Hudba, ticho nebo pov√≠d√°n√≠ ‚Äì podle dohody.</p>
              <span class="bio-highlight">C√≠lem je, aby cesta nebyla jen p≈ôesun, ale p≈ô√≠jemn√° ƒç√°st dne.</span>
          </div>

          <div class="fun-fact-box">
              <span class="fun-fact-icon">üí°</span>
              <span><strong>Fun fact:</strong> D√≠ky tanci jsem se jednou dostal ke stolu jednoho z nejbohat≈°√≠ch lid√≠ v ƒåesku üòÑ</span>
          </div>

          <div class="car-card">
              <div class="car-header">
                  üöó Auto, kter√Ωm pojede≈°
              </div>
              <span class="car-model">Volkswagen Arteon Shooting Brake</span>
              
              <ul class="car-specs-list">
                  <li><span class="check-icon">‚úì</span> 147 kW diesel ¬∑ automat</li>
                  <li><span class="check-icon">‚úì</span> Tich√© pr√©miov√© kombi</li>
                  <li><span class="check-icon">‚úì</span> Hodnƒõ m√≠sta na nohy i zavazadla</li>
                  <li><span class="check-icon">‚úì</span> Pohodln√© i na dlouh√© trasy</li>
              </ul>

              <div class="car-features-mini">
                  <div class="feature-item">
                      <svg class="feature-icon" viewBox="0 0 24 24"><path d="M20 12V7H4V12H20M20 7C22.76 7 25 9.24 25 12H4C4 9.24 6.24 7 9 7M2 12V17H22V12H2M2 17C2 18.11 2.9 19 4 19V21H20V19C21.11 19 22 18.11 22 17H2Z"/></svg>
                      Komfort
                  </div>
                  <div class="feature-item">
                      <svg class="feature-icon" viewBox="0 0 24 24"><path d="M16.5 12C16.5 10.23 15.48 8.71 14 7.97V16.02C15.48 15.29 16.5 13.77 16.5 12M19 12C19 12.94 18.8 13.82 18.46 14.64L19.97 16.15C20.62 14.91 21 13.5 21 12C21 7.72 18 4.14 14 3.23V5.29C16.89 6.15 19 8.83 19 12M3.27 3L2 4.27L7.73 10H4V14H9L14 19V16.27L19.73 22L21 20.73L3.27 3M14 5V10.17L11.83 8H14V5Z"/></svg>
                      Ticho
                  </div>
                  <div class="feature-item">
                      <svg class="feature-icon" viewBox="0 0 24 24"><path d="M4 3H20V5H4V3M4 19H20V21H4V19M2 7H22V9H2V7M2 15H22V17H2V15M6 11H18V13H6V11Z"/></svg>
                      Prostor
                  </div>
              </div>
              <div style="font-size:10px; color:#64748b; margin-top:10px; text-align:right;">
                  (viz rozlo≈æen√≠ vpravo ‚Üí)
              </div>
          </div>
        </div>

        <div class="car-gallery-grid">
          <img src="01.png" class="gallery-thumb" alt="Arteon Front">
          <img src="02.png" class="gallery-thumb" alt="Arteon Rear">
          <img src="03.png" class="gallery-thumb" alt="Interior">
          <img src="04.png" class="gallery-thumb" alt="Trunk">
          <img src="05.png" class="gallery-thumb" alt="Cockpit">
          <img src="06.png" class="gallery-thumb" alt="Side">
        </div>

        <div class="step-container" id="step1">
          <div class="step-header"><div class="step-num">1</div> VYBER CESTU</div>
          <select id="tripSelect">
            <option value="">‚Äì Naƒç√≠t√°m term√≠ny... ‚Äì</option>
          </select>
        </div>

        <div class="step-container hidden" id="step2">
          <div class="step-header"><div class="step-num">2</div> <span id="stopHeaderTitle">KDE VYSTUPUJI?</span></div>
          <div class="radio-group" id="stopRadios">
            <label class="radio-item">
              <input type="radio" name="stop" value="praha" data-price="50">
              <span>Praha (50 CHF)</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="stop" value="brno" data-price="70">
              <span>Brno (70 CHF)</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="stop" value="ostrava" data-price="80">
              <span>Ostrava (80 CHF)</span>
            </label>
          </div>
        </div>

        <div class="step-container hidden" id="step3">
          <div class="step-header"><div class="step-num">3</div> O Mƒö</div>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <input type="text" id="custName" placeholder="Tv√© jm√©no (Doporuƒçeno)" />
            <input type="tel" id="custPhone" placeholder="Telefon (Doporuƒçeno)" />
            <input type="email" id="custEmail" placeholder="Tv≈Øj Email (Pro potvrzen√≠)" />
          </div>
          <div style="margin-top:10px; font-size:11px; color:#64748b;">
            Pokud vypln√≠≈° email, p≈ôijde ti automatick√© potvrzen√≠.
          </div>
        </div>

        <div style="margin-top:20px; font-size:11px; text-align:center;">
          <a href="admin.html" style="color:#475569; text-decoration:none;">Admin p≈ô√≠stup</a>
        </div>
      </section>

      <section class="card">
        <div class="step-header"><div class="step-num">4</div> VYBER M√çSTO</div>
        
        <div class="car-visual">
          <img src="car-top-vertical.jpg" alt="Car Top View" />

          <div class="stats-float" id="statsBox" style="display:none;">
            <div class="stat-row">Volno: <strong class="stat-num free" id="freeVal">3</strong></div>
            <div class="stat-row">Obsazeno: <strong class="stat-num" id="bookedVal">0</strong></div>
          </div>

          <div class="seat-grid">
            <div class="seat driver-seat" data-seat-id="DRV">
              <img src="driver-wheel.png" class="seat-icon" alt="Driver">
              <div class="seat-label">DRIVER</div>
            </div>
            <div class="seat" data-seat-id="VIP">
              <img src="vip-icon.png" class="seat-icon">
              <div class="seat-label">CO-PILOT</div>
            </div>
            <div class="seat" data-seat-id="MB">
              <div class="seat-label">MOOD<br>BRINGER</div>
            </div>
            <div class="seat" data-seat-id="DJ">
              <div class="seat-label">CHIEF<br>DJ</div>
            </div>
          </div>
        </div>

        <div class="legend">
          <div><span class="dot free"></span>Volno</div>
          <div><span class="dot selected"></span>Vybr√°no</div>
          <div><span class="dot booked"></span>Obsazeno</div>
        </div>

        <div class="step-container hidden" id="step5" style="margin-top:20px;">
            <div class="step-header"><div class="step-num">5</div> DODATKOV√â SLU≈ΩBY</div>
            <div class="checkbox-group" id="addonsList">
                </div>
        </div>

        <div class="btn-block">
          <div class="price-display" id="priceDisplay"></div>
          <button id="confirmBtn" class="btn-main" disabled>Potvrdit v√Ωbƒõr</button>
          <div id="message" class="message"></div>
        </div>

        <div class="success-box" id="successBox">
          <div class="success-title">‚úÖ Rezervov√°no! Odeslat potvrzen√≠:</div>
          <div class="social-btns">
            <a href="#" id="waBtn" target="_blank" class="social-btn wa">
              <svg class="social-icon" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
              WhatsApp
            </a>
            <a href="#" id="msBtn" class="social-btn ms">
              <svg class="social-icon" viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 4.974 0 11.111c0 3.498 1.744 6.614 4.504 8.658.232.172.376.447.376.733v2.336a.872.872 0 001.352.738l2.646-1.603a.925.925 0 01.597-.133 12.858 12.858 0 002.525.251c6.627 0 12-4.974 12-11.111C24 4.974 18.627 0 12 0zm1.321 14.397L10.3 11.16a.918.918 0 00-1.168-.088l-4.54 3.447c-.504.382-1.156-.257-.804-.791l3.02-4.582a.916.916 0 001.168.087l3.023 2.152a.92.92 0 001.168.088l4.54-3.447c.504-.383 1.155.257.803.79l-3.02 4.583a.918.918 0 00-1.169-.088v-.001z"/></svg>
              Messenger <span class="copy-hint">(text se zkop√≠ruje)</span>
            </a>
            <a href="#" id="emBtn" target="_blank" class="social-btn em">
              <svg class="social-icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              Odeslat Email
            </a>
          </div>
        </div>

        <div class="legal-links">
          <a href="./privacy-policy.html">Ochrana soukrom√≠</a> | <a href="./terms.html">Podm√≠nky</a>
        </div>
        
        <div class="footer-disclaimer">
            J√≠zdy jsou poskytov√°ny formou soukrom√© spoluj√≠zdy na z√°kladƒõ domluvy.<br>
            Nejedn√° se o taxislu≈æbu ani ve≈ôejnou p≈ôepravu.
        </div>
      </section>
    </main>
    
    <div id="lightbox" class="lightbox">
        <div class="lightbox-close-hint" id="closeLightboxBtn">Zav≈ô√≠t (Esc)</div>
        <div class="lightbox-content-wrapper">
          <button class="nav-btn nav-prev" id="prevBtn">‚ùÆ</button>
          <img id="lightboxImg" src="" alt="Full view">
          <button class="nav-btn nav-next" id="nextBtn">‚ùØ</button>
        </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1) FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAi6MYAsAnqJg_5XwQC7b6TAI1ywrrADsM",
      authDomain: "car-seats-booking.firebaseapp.com",
      projectId: "car-seats-booking",
      storageBucket: "car-seats-booking.firebasestorage.app",
      messagingSenderId: "193508754028",
      appId: "1:193508754028:web:f7bc0b8cbdee9ef355ce49",
      measurementId: "G-QGXXTCG7XG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 2) CONTACT INFO (from DB)
    let config = {
        whatsapp: "+41767775898",
        messenger: "https://www.facebook.com/messages/t/ales.krajina",
        email: "ales.krajina@outlook.com",
        instagram: "https://www.instagram.com/ak.in.motion_/",
        facebook_profile: ""
    };

    const SEAT_IDS = ["VIP", "MB", "DJ"]; 
    const STOP_PRICES = { praha: 50, brno: 70, ostrava: 80 };
    const STOP_NAMES_LOCATIVE = { praha: "Praze", brno: "Brnƒõ", ostrava: "Ostravƒõ" };

    // DEFINICE DODATKOV√ùCH SLU≈ΩEB
    const ADDONS = [
        { category: "V√Ωzvednut√≠ & Flexibilita" },
        { id: "pickup", label: "V√Ωzvednut√≠ v r√°mci mƒõsta Z√ºrich (dle domluvy)", price: 0 },
        { id: "detour30", label: "Zaj√≠≈æƒèka do cca 30 min (+10 CHF)", price: 10 },
        { id: "detour60", label: "Zaj√≠≈æƒèka do cca 60 min (+20 CHF)", price: 20 },
        
        { category: "Obƒçerstven√≠ & Komfort" },
        { id: "water", label: "Voda zdarma, nealko k dispozici", price: 0, checked: true, disabled: true },
        { id: "prosecco", label: "Courtesy prosecco / champagne na vy≈æ√°d√°n√≠", price: 0 },
        
        { category: "Technologie" },
        { id: "tech", label: "Wi-Fi hotspot, nab√≠jeƒçky, tablet", price: 0, checked: true, disabled: true },
        
        { category: "Praktiƒçnost" },
        { id: "extra", label: "Extra zavazadla, pets, dƒõtsk√° sedaƒçka (po domluvƒõ)", price: 0 }
    ];

    let trips = [];
    let currentTripId = "";
    let currentTripObj = null;
    let currentStop = "";
    let selectedSeats = new Set();
    let selectedAddons = new Set();
    let bookedSeats = new Set(); 
    let currentSummaryText = ""; 

    function setMessage(text, type = "") {
      const msgEl = document.getElementById("message");
      msgEl.className = "message " + type;
      msgEl.textContent = text;
    }

    function formatTripLabel(t) { return `${t.date} ‚Äì ${t.from} ‚Üí ${t.to}`; }

    // --- LOGIC ---
    async function fetchContactSettings() {
        try {
            const docRef = doc(db, "settings", "public_contact");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if(data.whatsapp) config.whatsapp = data.whatsapp;
                if(data.messenger) config.messenger = data.messenger;
                if(data.email) config.email = data.email;
                if(data.instagram) config.instagram = data.instagram;
                if(data.facebook_profile) config.facebook_profile = data.facebook_profile;
                
                // Update Social Icons UI
                const instaBtn = document.getElementById("lnkInsta");
                const fbBtn = document.getElementById("lnkFb");
                
                if(config.instagram) { instaBtn.href = config.instagram; instaBtn.style.display = "flex"; }
                if(config.facebook_profile) { fbBtn.href = config.facebook_profile; fbBtn.style.display = "flex"; }
            } else {
                const instaBtn = document.getElementById("lnkInsta");
                if(config.instagram) { instaBtn.href = config.instagram; instaBtn.style.display = "flex"; }
            }
        } catch (e) {
            console.warn("DB config load failed, using defaults.");
        }
    }

    async function fetchTrips() {
      const q = await getDocs(collection(db, "trips"));
      const list = [];
      
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);

      q.forEach(d => {
        const t = d.data();
        const tripDate = new Date(t.trip_date);
        
        if (tripDate >= yesterday) {
            list.push({ id: d.id, date: t.trip_date, from: t.from_city||"?", to: t.to_city||"?" });
        }
      });
      list.sort((a,b) => new Date(a.date) - new Date(b.date));
      return list;
    }

    async function fetchBookedSeats(tripId) {
      const q = query(collection(db, "bookings"), where("trip_id", "==", tripId));
      const snap = await getDocs(q);
      const s = new Set();
      snap.forEach(d => s.add(d.data().seat_code));
      return s;
    }

    // EMAIL AUTOMATION FUNCTION
    function sendEmailNotification(summary, customerEmail, customerName, tripInfo, addonsText, totalPrice) {
        
        // 1. EMAIL PRO MAJITELE (ALE≈†E)
        const templateParamsOwner = {
            to_email: config.email,
            subject: `Nov√° rezervace: ${currentTripObj.date} (${customerName || 'Nezn√°m√Ω'})`,
            message: summary
        };
        emailjs.send("service_ilwube6", "template_v454mth", templateParamsOwner)
            .then(() => console.log("Email owner sent"))
            .catch(e => console.error("Email owner failed", e));

        // 2. EMAIL PRO Z√ÅKAZN√çKA (POKUD VYPLNIL EMAIL)
        if (customerEmail && customerEmail.includes("@")) {
            
            const customerMsg = `Ahoj ${customerName || "cestovateli"},\n\n` +
                                `potvrzuji p≈ôijet√≠ tv√© rezervace na cestu ${tripInfo}.\n\n` +
                                `Detaily:\n` +
                                `Cena celkem: ${totalPrice} CHF\n` +
                                `${addonsText ? 'Slu≈æby nav√≠c: ' + addonsText + '\n' : ''}` +
                                `\nBrzy se ti ozvu s p≈ôesn√Ωm ƒçasem a m√≠stem setk√°n√≠.\n\n` +
                                `Tƒõ≈°√≠m se na cestu,\nAle≈°`;

            const templateParamsCust = {
                to_email: customerEmail,
                subject: "Potvrzen√≠ rezervace - Arteon Ride",
                message: customerMsg
            };
            emailjs.send("service_ilwube6", "template_v454mth", templateParamsCust)
                .then(() => console.log("Email customer sent"))
                .catch(e => console.error("Email customer failed", e));
        }
    }

    async function createBookings({ tripId, stopCity, price, seats, addons, name, phone, email }) {
      const promises = seats.map(seat => {
        return addDoc(collection(db, "bookings"), {
          trip_id: tripId,
          seat_code: seat,
          stop_city: stopCity,
          price_chf: price,
          addons: addons, 
          customer_name: name || null,
          customer_phone: phone || null,
          customer_email: email || null,
          created_at: new Date().toISOString()
        });
      });
      await Promise.all(promises);
    }

    function renderAddons() {
        const container = document.getElementById("addonsList");
        container.innerHTML = "";
        
        ADDONS.forEach(item => {
            if(item.category) {
                const cat = document.createElement("div");
                cat.className = "addon-category";
                cat.textContent = item.category;
                container.appendChild(cat);
                return;
            }
            
            const label = document.createElement("label");
            label.className = "addon-item";
            if(item.disabled) label.style.opacity = "0.7";
            
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = item.id;
            checkbox.dataset.price = item.price;
            
            if(item.checked) checkbox.checked = true;
            if(item.disabled) checkbox.disabled = true;
            
            checkbox.addEventListener("change", () => {
               if(checkbox.checked) selectedAddons.add(item.id);
               else selectedAddons.delete(item.id);
               updateStatusAndPrice();
            });

            if(item.checked && !item.disabled) selectedAddons.add(item.id);

            const spanText = document.createElement("span");
            spanText.className = "addon-label";
            spanText.textContent = item.label;
            
            label.appendChild(checkbox);
            label.appendChild(spanText);
            
            if(item.price > 0) {
                const spanPrice = document.createElement("span");
                spanPrice.className = "addon-price";
                spanPrice.textContent = `+${item.price} CHF`;
                label.appendChild(spanPrice);
            }
            
            container.appendChild(label);
        });
    }

    // WIZARD UI LOGIC
    function updateStepsVisibility() {
      const step2 = document.getElementById("step2");
      const step3 = document.getElementById("step3");
      const step5 = document.getElementById("step5");
      
      if (currentTripId) {
        const isFull = bookedSeats.size >= 3;
        if (isFull) {
            step2.classList.add("hidden"); step3.classList.add("hidden"); step5.classList.add("hidden");
            setMessage("Tato j√≠zda je plnƒõ obsazena.", "error");
            return;
        }
        step2.classList.remove("hidden");
        const stopTitle = document.getElementById("stopHeaderTitle");
        if(currentTripObj.from === "Zurich") stopTitle.textContent = "KDE VYSTUPUJI?";
        else stopTitle.textContent = "KDE NASTUPUJI?";
        setMessage("");
      } else {
        step2.classList.add("hidden"); step3.classList.add("hidden"); step5.classList.add("hidden");
        return;
      }
      
      if (currentStop) {
          step3.classList.remove("hidden");
          step5.classList.remove("hidden"); 
      } else {
          step3.classList.add("hidden");
          step5.classList.add("hidden");
      }
    }

    function updateSeatVisuals() {
      const seats = document.querySelectorAll(".seat");
      seats.forEach(seat => {
        const id = seat.dataset.seatId;
        seat.classList.remove("selected", "booked", "disabled", "driver-seat");
        if (id === "DRV") { seat.classList.add("driver-seat"); return; }
        if (!currentTripId) { seat.classList.add("disabled"); return; }
        if (bookedSeats.has(id)) { seat.classList.add("booked"); return; }
        if (selectedSeats.has(id)) { seat.classList.add("selected"); }
      });
    }

    function updateStatusAndPrice() {
      const priceEl = document.getElementById("priceDisplay");
      const confirmBtn = document.getElementById("confirmBtn");
      const successBox = document.getElementById("successBox");
      const statsBox = document.getElementById("statsBox");
      const bookedVal = document.getElementById("bookedVal");
      const freeVal = document.getElementById("freeVal");

      successBox.style.display = "none";
      confirmBtn.style.display = "inline-block";

      if (!currentTripId) {
        statsBox.style.display = "none"; priceEl.textContent = ""; confirmBtn.disabled = true; return;
      }
      statsBox.style.display = "block";
      const bookedCount = [...bookedSeats].filter(s => SEAT_IDS.includes(s)).length;
      const freeCount = SEAT_IDS.length - bookedCount;
      bookedVal.textContent = bookedCount;
      freeVal.textContent = freeCount;

      if (!currentStop) {
        priceEl.textContent = "Vyber zast√°vku (Krok 2)"; confirmBtn.disabled = true; return;
      }
      
      const baseSeatPrice = STOP_PRICES[currentStop] || 0;
      const seatCount = selectedSeats.size;
      
      let addonsTotal = 0;
      ADDONS.forEach(a => {
          if(selectedAddons.has(a.id)) addonsTotal += (a.price || 0);
      });

      if (seatCount > 0) {
        const seatsTotal = seatCount * baseSeatPrice;
        const finalTotal = seatsTotal + addonsTotal;
        
        let txt = `${seatCount} √ó ${baseSeatPrice} CHF`;
        if(addonsTotal > 0) txt += ` + ${addonsTotal} CHF slu≈æby`;
        txt += ` = ${finalTotal} CHF`;
        
        priceEl.textContent = txt;
        confirmBtn.disabled = false;
      } else {
        priceEl.textContent = "Vyber sedadla (Krok 4)"; confirmBtn.disabled = true;
      }
    }

    function buildSummaryText({ trip, stop, seats, basePrice, name, phone, addonsTotal }) {
      let seatsArr = Array.isArray(seats) ? seats : Array.from(seats);
      const seatsTotal = seatsArr.length * basePrice;
      const finalTotal = seatsTotal + addonsTotal;
      const stopLocative = STOP_NAMES_LOCATIVE[stop] || stop;
      const seatsStr = seatsArr.join(", ");
      
      let selectedAddonLabels = [];
      ADDONS.forEach(a => {
          if(selectedAddons.has(a.id) && !a.disabled) selectedAddonLabels.push(a.label);
      });

      let msg = `Ahoj Ale≈°i,\n\nr√°d bych si objednal cestu ${trip.date} ‚Äì ${trip.from} ‚Üí ${trip.to}.\n`;
      msg += `N√°stup v ${stopLocative}, sedadla: ${seatsStr}.\n`;
      
      if(selectedAddonLabels.length > 0) {
          msg += `Extra slu≈æby: ${selectedAddonLabels.join(", ")}.\n`;
      }
      
      msg += `Celkem: ${finalTotal} CHF.\n`;
      
      if(name) msg += `\nJm√©no: ${name}`;
      if(phone) msg += `\nTel: ${phone}`;
      msg += `\n\nPros√≠m potvrƒè, ≈æe to plat√≠. Dƒõkuji.`;
      
      return { msg, selectedAddonLabels, finalTotal };
    }

    function showSuccess(summaryText) {
      currentSummaryText = summaryText; 
      const box = document.getElementById("successBox");
      const btn = document.getElementById("confirmBtn");
      btn.style.display = "none";
      const waBtn = document.getElementById("waBtn");
      const emBtn = document.getElementById("emBtn");
      const waPhone = config.whatsapp.replace(/\D/g, ""); 
      waBtn.href = `https://wa.me/${waPhone}?text=${encodeURIComponent(summaryText)}`;
      emBtn.href = `mailto:${config.email}?subject=Rezervace Arteon&body=${encodeURIComponent(summaryText)}`;
      box.style.display = "block";
      box.scrollIntoView({ behavior: 'smooth' });
    }

    // === LIGHTBOX LOGIC ===
    let galleryImages = [];
    let currentImgIndex = 0;

    function openLightbox(index) {
        const lightbox = document.getElementById('lightbox');
        const img = document.getElementById('lightboxImg');
        currentImgIndex = index;
        img.src = galleryImages[currentImgIndex];
        lightbox.style.display = 'flex';
        document.addEventListener('keydown', handleKeydown);
    }

    function closeLightbox() {
        document.getElementById('lightbox').style.display = 'none';
        document.removeEventListener('keydown', handleKeydown);
    }

    function nextImage() {
        currentImgIndex = (currentImgIndex + 1) % galleryImages.length;
        document.getElementById('lightboxImg').src = galleryImages[currentImgIndex];
    }

    function prevImage() {
        currentImgIndex = (currentImgIndex - 1 + galleryImages.length) % galleryImages.length;
        document.getElementById('lightboxImg').src = galleryImages[currentImgIndex];
    }

    function handleKeydown(e) {
        if(e.key === 'Escape') closeLightbox();
        if(e.key === 'ArrowRight') nextImage();
        if(e.key === 'ArrowLeft') prevImage();
    }

    // NOV√Å FUNKCE: Check availability
    async function checkAllTripsAvailability() {
        for(const t of trips) {
            const seats = await fetchBookedSeats(t.id);
            if(seats.size >= 3) {
                const opt = document.querySelector(`option[value="${t.id}"]`);
                if(opt) {
                    opt.disabled = true;
                    opt.textContent += " (PLNO)";
                }
            }
        }
    }

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", async () => {
      fetchContactSettings();
      renderAddons(); 

      // Setup Lightbox
      const thumbs = document.querySelectorAll('.gallery-thumb');
      galleryImages = Array.from(thumbs).map(img => img.src);
      thumbs.forEach((thumb, index) => thumb.addEventListener('click', () => openLightbox(index)));
      document.getElementById('closeLightboxBtn').addEventListener('click', closeLightbox);
      document.getElementById('lightbox').addEventListener('click', (e) => {
          if(e.target.id === 'lightbox' || e.target.classList.contains('lightbox-content-wrapper')) closeLightbox();
      });
      document.getElementById('nextBtn').addEventListener('click', (e) => { e.stopPropagation(); nextImage(); });
      document.getElementById('prevBtn').addEventListener('click', (e) => { e.stopPropagation(); prevImage(); });

      // Load Trips
      setMessage("Naƒç√≠t√°m j√≠zdy...");
      try {
        trips = await fetchTrips();
        const sel = document.getElementById("tripSelect");
        sel.innerHTML = "";
        const def = document.createElement("option");
        def.value = ""; def.textContent = "‚Äì Vyber term√≠n ‚Äì";
        sel.appendChild(def);
        trips.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.id; opt.textContent = formatTripLabel(t);
          sel.appendChild(opt);
        });
        
        await checkAllTripsAvailability();
        setMessage("");
      } catch(e) { console.error(e); setMessage("Chyba p≈ôipojen√≠.", "error"); }

      // Listeners
      document.getElementById("tripSelect").addEventListener("change", async (e) => {
        currentTripId = e.target.value;
        currentTripObj = trips.find(t => t.id === currentTripId);
        currentStop = ""; selectedSeats.clear(); bookedSeats.clear();
        document.querySelectorAll('input[name="stop"]').forEach(r => r.checked = false);
        
        updateStepsVisibility();
        updateSeatVisuals();
        updateStatusAndPrice();

        if(currentTripId) {
          setMessage("Ovƒõ≈ôuji obsazenost...");
          bookedSeats = await fetchBookedSeats(currentTripId);
          setMessage("");
          updateStepsVisibility(); 
          updateSeatVisuals();
          updateStatusAndPrice();
        }
      });

      document.querySelectorAll('input[name="stop"]').forEach(radio => {
        radio.addEventListener("change", (e) => {
          currentStop = e.target.value;
          updateStepsVisibility();
          updateStatusAndPrice();
        });
      });

      document.querySelectorAll(".seat").forEach(seat => {
        seat.addEventListener("click", (e) => {
          const id = e.currentTarget.dataset.seatId;
          if(id === "DRV" || !currentTripId || bookedSeats.has(id)) return;
          if(selectedSeats.has(id)) selectedSeats.delete(id);
          else selectedSeats.add(id);
          updateSeatVisuals();
          updateStatusAndPrice();
        });
      });

      document.getElementById("msBtn").addEventListener("click", (e) => {
        e.preventDefault(); 
        navigator.clipboard.writeText(currentSummaryText).then(() => {
            alert("Text zpr√°vy zkop√≠rov√°n! V Messengeru ho vlo≈æte (Ctrl+V).");
            window.open(config.messenger, '_blank');
        }).catch(() => {
            window.open(config.messenger, '_blank');
        });
      });

      document.getElementById("confirmBtn").addEventListener("click", async () => {
        if(!currentTripId || !currentStop || selectedSeats.size === 0) return;
        const name = document.getElementById("custName").value.trim();
        const phone = document.getElementById("custPhone").value.trim();
        const email = document.getElementById("custEmail").value.trim();
        
        const basePrice = STOP_PRICES[currentStop];
        const seatsArr = [...selectedSeats];
        
        let addonsTotal = 0;
        let addonsArr = [];
        ADDONS.forEach(a => {
            if(selectedAddons.has(a.id)) {
                addonsTotal += (a.price || 0);
                addonsArr.push(a.id);
            }
        });

        setMessage("Ukl√°d√°m...");
        try {
          await createBookings({
            tripId: currentTripId, stopCity: currentStop, price: basePrice, 
            seats: seatsArr, addons: addonsArr, name, phone, email
          });
          
          bookedSeats = await fetchBookedSeats(currentTripId);
          
          const summaryData = buildSummaryText({
            trip: currentTripObj, stop: currentStop, seats: seatsArr, basePrice, name, phone, addonsTotal
          });
          
          const fullMsg = summaryData.msg;
          const addonsText = summaryData.selectedAddonLabels.join(", ");
          
          // ODESLAT EMAIL AUTOMATICKY (Owner + Customer)
          sendEmailNotification(fullMsg, email, name, formatTripLabel(currentTripObj), addonsText, summaryData.finalTotal);

          selectedSeats.clear();
          updateSeatVisuals();
          updateStatusAndPrice();
          setMessage("");
          showSuccess(fullMsg);
        } catch(e) {
          console.error(e);
          setMessage("Chyba: Sedadlo u≈æ je mo≈æn√° obsazen√©.", "error");
          bookedSeats = await fetchBookedSeats(currentTripId);
          updateSeatVisuals();
        }
      });
      updateStepsVisibility();
    });
  </script>
</body>
</html>
